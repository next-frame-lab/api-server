name: Java CI with Gradle

# ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # main ë˜ëŠ” develop ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  push:
    branches: [ "main", "develop" ]
  # main, develop, release, hotfix ë¸Œëœì¹˜ ëŒ€ìƒìœ¼ë¡œ pull request ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  pull_request:
    branches: [ "main", "develop", "release/*", "hotfix/*" ]

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œ Gradle ë¹Œë“œì— ëŒ€í•œ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤.
permissions:
  contents: read

# ì‹¤í–‰ë  ì‘ì—…(job)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤. ì´ ì›Œí¬ í”Œë¡œìš°ëŠ” 'build'ë¼ëŠ” ë‹¨ì¼ ì‘ì—…ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.
jobs:
  build:
    # ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U testuser -d testdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # ì‘ì—… ë‚´ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë  ë‹¨ê³„(step)ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
    steps:
      # 1. 'actions/checkout' ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 'actions/setup-java' ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ JDK 21ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. gradlew ìŠ¤í¬ë¦½íŠ¸ì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. ê° ëª¨ë“ˆì˜ ì„¤ì • íŒŒì¼ì„ Secret ê°’ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Create configuration files for payment module
        run: |
          mkdir -p ./payment/src/main/resources
          cat <<'EOF' > ./payment/src/main/resources/application.yml
          ${{ secrets.PAYMENT_APPLICATION_YML }}
          EOF
          cat <<'EOF' > ./payment/src/main/resources/application-dev.yml
          ${{ secrets.PAYMENT_APPLICATION_DEV_YML }}
          EOF
          cat <<'EOF' > ./payment/src/main/resources/application-dev-db.yml
          ${{ secrets.PAYMENT_APPLICATION_DEV_DB_YML }}
          EOF

      - name: Create configuration files for schedule-reservation-ticketing module
        run: |
          mkdir -p ./schedule-reservation-ticketing/src/main/resources
          cat <<'EOF' > ./schedule-reservation-ticketing/src/main/resources/application.yml
          ${{ secrets.SRT_APPLICATION_YML }}
          EOF
          cat <<'EOF' > ./schedule-reservation-ticketing/src/main/resources/application-dev-mail.yml
          ${{ secrets.SRT_APPLICATION_DEV_MAIL_YML }}
          EOF

      - name: ğŸ§ [DEBUG] Display SRT application.yml content
        run: |
          echo "--- Content of schedule-reservation-ticketing/src/main/resources/application.yml ---"
          cat ./schedule-reservation-ticketing/src/main/resources/application.yml
          echo "------------------------------------------------------------------------------------"

      - name: Validate YAML files
        run: |
          for file in $(find . -name "*.yml"); do
            echo "Validating $file ..."
            python3 -c "import yaml, sys; yaml.safe_load(open('$file'))" || exit 1
          done


      # 5. Gradleì„ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
      - name: Build and test modules with Gradle
        env:
          SPRING_PROFILES_ACTIVE: dev
          SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpassword
          SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
        run: ./gradlew clean :payment:build :schedule-reservation-ticketing:build --stacktrace -Dlogging.level.org.springframework.boot.context.config=DEBUG